{% assign storybook_path = site.storybook_path %}
{% if include.is_mobile %}
  {% assign storybook_path = site.storybook_mobile_path %}
{% endif %}
{% assign storybook_iframe_path = storybook_path | append: '/iframe.html?id=' | append: include.story | append: '&viewMode=story' %}

<style>
  iframe {
    border: none;
    width: 100%;
    min-height: 300px; /* fallback height */
    opacity: 0;
    transition: opacity 0.3s ease;
    display: block;
  }
</style>

<div
  class="site-showcase"
  style="max-width: {{ include.width | default: '100%' }}"
>
  <iframe
    id="{{ include.story }}"
    src="{{ storybook_iframe_path }}"
    title="Storybook: {{ include.story }}"
  ></iframe>
</div>

{% assign story_name_prefix = '' %}
{% if include.is_mobile %}
  {% assign story_name_prefix = 'va-mobile_' %}
{% endif %}
{% assign storybook_preview_path = site.storybook_path | append: '/?path=/story/' | append: story_name_prefix | append: include.story %}

[<img aria-hidden="true" role="img" src="{{ site.baseurl }}/images/storybook.svg" class="site-component-resources-links__icon" width="16px" alt="Storybook logo">View {{ include.link_text | default: 'this' }} in Storybook]({{ storybook_preview_path }})

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const iframe = document.getElementById('{{ include.story }}');

    function isValidOrigin(eventOrigin, iframeSrc) {
      return eventOrigin === new URL(iframeSrc).origin;
    }

    let messageReceived = false;

    window.addEventListener('message', function (event) {
      if (!isValidOrigin(event.origin, iframe.src)) return;

      const { type, height } = event.data || {};
      if (type === 'storybook-resize' && height) {
        messageReceived = true;
        iframe.style.height = `${height}px`;
        iframe.style.opacity = '1'; // Make iframe visible after height adjustment
      }
    });

    // Fallback if no message is received within 2 seconds
    setTimeout(() => {
      if (!messageReceived) {
        iframe.style.opacity = '1'; // Ensure iframe is visible
        iframe.style.height = iframe.style.height || '600px'; // Use fallback height only if not set
      }
    }, 2000);
  });
</script>