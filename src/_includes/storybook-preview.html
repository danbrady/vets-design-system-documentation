{% assign storybook_path = site.storybook_path %}
{% if include.is_mobile %}
  {% assign storybook_path = site.storybook_mobile_path %}
{% endif %}
{% assign storybook_iframe_path = storybook_path | append: '/iframe.html?id=' | append: include.story | append: '&viewMode=story' %}

<style>
  /* iframe {
    border: none;
    width: 100%;
    min-height: 300px;  fallback height
    opacity: 0;
    transition: opacity 0.3s ease;
    display: block;
  } */
</style>

<div
  class="site-showcase"
  style="max-width: {{ include.width | default: '100%' }}"
>
  <iframe
    class="storybook-embed"
    id="{{ include.story }}"
    src="{{ storybook_iframe_path }}"
    title="Storybook: {{ include.story }}"
  ></iframe>
</div>

{% assign story_name_prefix = '' %}
{% if include.is_mobile %}
  {% assign story_name_prefix = 'va-mobile_' %}
{% endif %}
{% assign storybook_preview_path = site.storybook_path | append: '/?path=/story/' | append: story_name_prefix | append: include.story %}

[<img aria-hidden="true" role="img" src="{{ site.baseurl }}/images/storybook.svg" class="site-component-resources-links__icon" width="16px" alt="Storybook logo">View {{ include.link_text | default: 'this' }} in Storybook]({{ storybook_preview_path }})

<script>
    function injectResizeScript(iframe, id) {
    const script = `
      (function () {
        let lastHeight = 0;

        function sendHeight() {
          const height = document.documentElement.scrollHeight;
          if (height !== lastHeight) {
            lastHeight = height;
            window.parent.postMessage({
              type: 'storybook-resize',
              id: '${id}',
              height
            }, '*');
          }
        }

        const observer = new ResizeObserver(sendHeight);
        observer.observe(document.body);

        setInterval(sendHeight, 300);
        window.addEventListener('DOMContentLoaded', sendHeight);
      })();
    `;

    const blob = new Blob([script], { type: 'text/javascript' });
    const blobUrl = URL.createObjectURL(blob);

    const inject = () => {
      try {
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        const s = doc.createElement('script');
        s.src = blobUrl;
        doc.head.appendChild(s);
      } catch (e) {
        // Might not be allowed due to cross-origin policy
        console.warn('Could not inject resize script:', e);
      }
    };

    // Try injecting after iframe loads
    iframe.addEventListener('load', inject);
  }

  document.querySelectorAll('iframe.storybook-embed').forEach((iframe) => {
    const id = iframe.dataset.storybookId;
    const autoResize = iframe.dataset.autoResize !== 'false';

    if (autoResize && id) {
      injectResizeScript(iframe, id);
    }
  });

  // Resize the iframe from the message sent by injected script
  window.addEventListener('message', (event) => {
    const { type, id, height } = event.data || {};
    if (type === 'storybook-resize' && id) {
      const iframe = document.querySelector(`iframe[data-storybook-id="${id}"]`);
      if (iframe && iframe.dataset.autoResize !== 'false') {
        iframe.style.height = height + 'px';
      }
    }
  });
</script>